---
title: "budget_s2s_analysis_FE7_proposal"
output: html_notebook
---

```{r}
library(tidyverse)
library(readxl)
library(janitor)
options(scipen = 0)
```


## Budget Analysis

```{r}
budget <- read_excel("budget_s2s_FE7_proposal.xlsx", sheet = " B1 Budget Detail", range = "A7:T77")
```

```{r}
names(budget)

```

```{r}
new_col_names <- c(
  "year", "component_country",
   "travel_local",  
  "travel_global", 
  "travel_regional",
  "payroll_direct_program_project_staff_salaries", 
  "programdelivery_pmo_oversight_costs",  
  "programdelivery_indirect_operational_costs", 
  "technology_tech_solutions_software",
  "technology_telecom", 
  "technology_LMS_and_other_digital_learning_tools_devices",
  "technology_digital_tech_analytics_mobile_social, cloud_robotics_ai_iot", 
  "technology_other_pls_specify",
  "educationalmaterials_content_delivery",
    "educationalmaterials_content_development",
    "educationalmaterials_other_pls_specify",
  "thirdpartyservices_vendors",
  "thirdpartyservices_implementation partners", 
  "thirdpartyservices_other_pls_specify",
  "other_other_pls_specify")
```

### Set column names
```{r}
budget <- budget %>% 
  set_names(new_col_names) 
budget <- budget %>% 
  filter(!component_country %in% c("YEAR 1", "TOTAL YEAR 1", "YEAR 2", "TOTAL YEAR 2", "YEAR 3", "TOTAL YEAR 3"))

budget <- budget %>%
  slice(-1)

```




```{r}
glimpse(budget)
```

```{r}
 budget <- budget %>% 
  mutate(across(year:component_country, as.factor)) %>% 
  mutate(across(travel_local:other_other_pls_specify, as.double))
```

## dataquality check: year and country/component

```{r}
 budget %>% 
  count(year)
budget %>% 
  count(component_country)
```

### Pivot longer the double columns
```{r}
budget <- budget %>% 
  pivot_longer(travel_local: other_other_pls_specify, names_to = "budget_head", values_to = "budget_amount")
budget
```

### Data quality check budget_head
```{r}
budget %>% 
  count(budget_head)
```

### Total_budget

```{r}
budget %>% 
  summarize(total_budget = sum(budget_amount, na.rm = T)) 
```


### Budget per year

```{r}
budget %>% 
  group_by(year) %>% 
  summarize(budget_total = sum(budget_amount, na.rm =T)) %>% 
   mutate(percent = budget_total/sum(budget_total)) %>% 
  mutate(percent = round(percent, 2)) %>% 
  mutate(percent = scales::percent(percent)) %>% 
  filter(budget_total != 0) %>% 
  arrange(year)
```

### Country
```{r}
budget %>% 
  group_by(component_country) %>% 
  summarize(budget_total = sum(budget_amount, na.rm =T)) %>% 
  mutate(percent = budget_total/sum(budget_total)) %>% 
  mutate(percent = round(percent, 2)) %>% 
  mutate(percent = scales::percent(percent)) %>% 
  filter(budget_total != 0) %>% 
  arrange(component_country)
  

```

```{r}
budget %>% 
  group_by(component_country) %>% 
  summarize(budget_total = sum(budget_amount, na.rm =T))
```


### Budget head

```{r}
budget %>% 
  group_by(budget_head) %>% 
  summarize(budget_total = round(sum(budget_amount, na.rm =T),0)) %>% 
  mutate(percent = budget_total/sum(budget_total)) %>% 
  mutate(percent = round(percent, 2)) %>% 
  mutate(percent = scales::percent(percent)) %>% 
  filter(budget_total != 0) %>% 
  arrange(budget_head)
```



## Skills to Succeed

```{r}
s2s <- read_excel("budget_s2s_FE7_proposal.xlsx", sheet = "B3. S2S Goal and Outcome", range = "A5:CH65") %>% 
  janitor::remove_empty() # Remove empty rows and/or columns from a data.frame or matrix.
 s2s 
```

# Updating column names using set_names
```{r}
col_names <-
  c("year", "metric", 
    "argentina_male", "argentina_female", "argentina_nb", "argentina_total", 
    "bolivia_male", "bolivia_female", "bolivia_nb", "bolivia_total",
    "brasil_male", "brasil_female", "brasil_nb", "brasil_total",
    "chad_male", "chad_female", "chad_nb", "chad_total",
    "chile_male", "chile_female", "chile_nb", "chile_total",
    "colombia_male", "colombia_female", "colombia_nb", "colombia_total",
    "dominicanrepublic_male", "dominicanrepublic_female", "dominicanrepublic_nb", "dominicanrepublic_total",
    "ecuador_male", "ecuador_female", "ecuador_nb", "ecuador_total",
    "elsalvador_male", "elsalvador_female", "elsalvador_nb", "elsalvador_total",
    "guatemala_male", "guatemala_female", "guatemala_nb", "guatemala_total",
    "haiti_male", "haiti_female", "haiti_nb", "haiti_total",
    "honduras_male", "honduras_female", "honduras_nb", "honduras_total",
    "mexico_male", "mexico_female", "mexico_nb", "mexico_total",
    "nicaragua_male", "nicaragua_female", "nicaragua_nb", "nicaragua_total",
    "panama_male", "panama_female", "panama_nb", "panama_total",
    "paraguay_male", "paraguay_female", "paraguay_nb", "paraguay_total",
    "peru_male", "peru_female", "peru_nb", "peru_total",
    "spain_male", "spain_female", "spain_nb", "spain_total",
    "uruguay_male", "uruguay_female", "uruguay_nb", "uruguay_total",
      "venezuela_male", "venezuela_female", "venezuela_nb", "venezuela_total",
      "ringfenced_male", "ringfenced_female", "ringfenced_nb", "ringfenced_total"
    )


```

### Set_names 
```{r}
s2s <-  s2s %>% 
  set_names(col_names) %>% 
  slice(-1, -2) %>% 
  filter(!str_detect(metric, "Total"))
s2s

```

```{r}
s2s <- s2s %>% 
  filter(!metric %in% c("YEAR 1", "YEAR 2", "YEAR 3"))
s2s
```

### Creating metric_cat column using existing metric column with mutate and case_when + arranging/selecting columns
```{r}
s2s <- s2s %>% 
  mutate(metric_cat = case_when( 
  metric == "Improved Career Management" ~ "Improved", 
metric == "Improved Mindset" ~ "Improved",
metric == "Skilled" ~ "Improved",
metric == "Obtained Work experience" ~ "Improved",
metric == "Re-entered Formal Education" ~ "Transformed",
metric == "Re-Invigorated commitment to education" ~ "Transformed",

metric == "Employed" ~"Transformed",
metric == "(Employed by Accenture) Subset of employed" ~"Transformed",
metric == "Increased Career Resilience" ~"Transformed",
metric == "Self-employed" ~"Transformed",
metric == "Grew business" ~"Transformed",
metric == "Started a business" ~"Transformed",
metric == "Connected" ~ "Connected", 
TRUE   ~ metric)) %>% 
  select(metric_cat, metric, everything()) 

s2s
```



### filter out non essential rows

```{r}
  filter_rows <- c("Connected", "Improved", "Transformed")
  
```

### Filtering only the Connected, Improved and Transformed related metric_cat and related sub metrics
```{r}
s2s <- s2s %>% 
  filter(metric_cat %in% filter_rows) 
s2s
```

```{r}
glimpse(s2s)
```

### Change the column types
```{r}
s2s <- s2s %>% 
  mutate(across(metric_cat:year, as.factor)) %>% 
  mutate(across(argentina_male:ringfenced_total, as.numeric))
s2s
```
### Pivot_longer
```{r}
s2s <- s2s %>% 
  pivot_longer(argentina_male:ringfenced_total, 
               names_to = "country_gender", 
               values_to = "figure") 
s2s
```

### Check data quality
```{r}
s2s %>% 
  count(metric)
s2s %>% 
  count(metric_cat)
s2s %>% 
  count(country_gender) 

```

# filter country_gender values where row contains _total using str_detect

```{r}
s2s <- s2s %>% 
  filter(!str_detect(country_gender, "_total"))

s2s

```

### Checking data quality country category again

```{r}
s2s %>% 
  count(country_gender)
```



### separting country_gender into two meaningful columns country and gender

```{r}
s2s <- s2s %>% 
  separate(country_gender, c("country", "gender"))

s2s
```

### Checking factor levels/count of each factor

```{r}
s2s %>% 
  count(metric_cat, sort = TRUE)
s2s %>% 
  count(metric, sort = TRUE)

s2s %>% 
  count(country)

s2s %>% 
  count(gender)
```

### CIT
```{r}
s2s %>% 
  group_by(metric_cat) %>% 
  summarize(total_s2s = sum(figure, na.rm = T))
```


### Metric

```{r}
s2s %>% 
  group_by(metric) %>% 
  summarize(total_s2s = sum(figure, na.rm = T)) %>% 
  arrange(desc(total_s2s)) %>% 
  filter(total_s2s != 0)
```


### metric_cat, country

```{r}
s2s %>% 
  group_by( metric_cat, country) %>% 
  summarize(s2s_total = sum(figure, na.rm = T)) %>% 
  mutate(percent = s2s_total/sum(s2s_total)) %>% 
  mutate(percent = round(percent, 2)) %>% 
  mutate(percent = scales::percent(percent)) %>% 
  filter(s2s_total != 0) %>% 
  arrange( metric_cat, country)

```


### metric_cat, country gender

```{r}
s2s %>% 
  group_by( metric_cat, country, gender) %>% 
  summarize(s2s_total = sum(figure, na.rm = T)) %>% 
  mutate(percent = s2s_total/sum(s2s_total)) %>% 
  mutate(percent = round(percent, 2)) %>% 
  mutate(percent = scales::percent(percent)) %>% 
  filter(s2s_total != 0) %>% 
  arrange( metric_cat, country)
```


### metric, country

```{r}
s2s %>% 
  group_by( metric, country) %>% 
  summarize(s2s_total = sum(figure, na.rm = T)) %>% 
  mutate(percent = s2s_total/sum(s2s_total)) %>% 
  mutate(percent = round(percent, 2)) %>% 
  mutate(percent = scales::percent(percent)) %>% 
  filter(s2s_total != 0) %>% 
  arrange( metric, country)

```




### Country gender

```{r}
s2s %>% 
  group_by(country, gender) %>% 
  summarize(s2s_total = sum(figure, na.rm = T)) %>% 
  mutate(percent = s2s_total/sum(s2s_total)) %>% 
  mutate(percent = round(percent, 2)) %>% 
  mutate(percent = scales::percent(percent)) %>% 
  filter(s2s_total != 0) %>% 
  arrange(country, gender)
```


#### metric cat, gender

```{r}
s2s %>% 
  group_by(metric_cat, gender) %>% 
  summarize(s2s_total = sum(figure, na.rm = T)) %>% 
  mutate(percent = s2s_total/sum(s2s_total)) %>% 
  mutate(percent = round(percent, 2)) %>% 
  mutate(percent = scales::percent(percent)) %>% 
  filter(s2s_total != 0)

```


```{r}
s2s %>% 
  filter(country != "spain") %>% 
  group_by(metric_cat, year, gender) %>% 
  summarize(total_figure = sum(figure, na.rm = T))
```

```{r}
s2s %>% 
  group_by(metric_cat, year) %>% 
  summarize(total_figure = sum(figure, na.rm = T))
```









